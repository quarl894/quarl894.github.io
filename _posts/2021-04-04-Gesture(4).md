---
layout: post
# title:  "Gesture(4)"
date:   2021-04-04 23:50:00 +0900
categories: Input, Android, Framework
tag: Android, Input
---

### [Gesture Event]

TouchInputMapper에서는 단순히 finger 터치 외에도 stylus, gesture 등을 처리합니다.
그 중 이번에는 Gesture event에 대해 알아보려 합니다.

## Gesture
Gesture를 가공하는 가장 중요한 메소드는 preparePointerGestures 입니다.
<mark>preparePointerGestures만 알면 Gesture가 어떻게 가공되는지 알 수 있습니다.</mark>

### cookAndDispatch
앞서 CookAndDispatch에서  POINTER일경우  PointerUsage판단해 넘겨준다.

```java
void TouchInputMapper::cookAndDispatch(nsecs_t when, nsecs_t readTime) {
    // Dispatch the touches either directly or by translation through a pointer on screen.
    if (mDeviceMode == DeviceMode::POINTER) {
    	if (!mCurrentCookedState.stylusIdBits.isEmpty()) {
        } else if (!mCurrentCookedState.fingerIdBits.isEmpty() ||
                   isPointerDown(mCurrentRawState.buttonState)) {
            pointerUsage = PointerUsage::GESTURES;
        }

        dispatchPointerUsage(when, readTime, policyFlags, pointerUsage);
```

### dispatchPointerUsage
 받은 pointerUsage에 따라 dispatchPointer로 전달.

```java
void TouchInputMapper::dispatchPointerUsage(nsecs_t when, nsecs_t readTime, uint32_t policyFlags, PointerUsage pointerUsage) {
    if (pointerUsage != mPointerUsage) {
        abortPointerUsage(when, readTime, policyFlags);
        mPointerUsage = pointerUsage;
    }

    switch (mPointerUsage) {
        case PointerUsage::GESTURES:
            dispatchPointerGestures(when, readTime, policyFlags, false /*isTimeout*/);
            break;
        case PointerUsage::STYLUS:
            dispatchPointerStylus(when, readTime, policyFlags);
            break;
        case PointerUsage::MOUSE:
            dispatchPointerMouse(when, readTime, policyFlags);
            break;
        case PointerUsage::NONE:
            break;
    }
}
```

### dispatchPointerGestures
 preparePointerGestures에서 성공적으로 받으면, 동작을 진행하고 아니면 끝낸다.
 preparePointerGestures에서  cancelPreviousGesture, finishPreviousGesture 또한 동작하는데 cancel일 경우 돌아와서 cancel을 보내고, finish일 경우에만 dispatchMotion으로 값을 보낸다.
Gesture 주요동작은 preparePointerGesture에서 결정된다고 보면 된다.

```java
void TouchInputMapper::dispatchPointerGestures(nsecs_t when, nsecs_t readTime, uint32_t policyFlags, bool isTimeout) {
// Update current gesture coordinates.
    bool cancelPreviousGesture, finishPreviousGesture;
    bool sendEvents = preparePointerGestures(when, &cancelPreviousGesture, &finishPreviousGesture, isTimeout);

    if (!sendEvents) {
        return;
    }
    if (finishPreviousGesture) {
        cancelPreviousGesture = false;
    }
    
// Update the pointer presentation and spots.
    if (mParameters.gestureMode == Parameters::GestureMode::MULTI_TOUCH) {
        mPointerController->setPresentation(PointerControllerInterface::Presentation::POINTER);
        if (finishPreviousGesture || cancelPreviousGesture) {
            mPointerController->clearSpots();
        }

        if (mPointerGesture.currentGestureMode == PointerGesture::Mode::FREEFORM) {
            setTouchSpots(mPointerGesture.currentGestureCoords,
                          mPointerGesture.currentGestureIdToIndex,
                          mPointerGesture.currentGestureIdBits, mPointerController->getDisplayId());
        }
    } else {
        mPointerController->setPresentation(PointerControllerInterface::Presentation::POINTER);
    }

// Show or hide the pointer if needed.
// PointerController->hide하는 부분 (생략)

    // cancelPreviousGesture이었다면 모든 포인터에 CANCEL 보냄.
    BitSet32 dispatchedGestureIdBits(mPointerGesture.lastGestureIdBits);
    if (!dispatchedGestureIdBits.isEmpty()) {
        if (cancelPreviousGesture) {
        dispatchMotion(when, readTime, policyFlags, mSource,AMOTION_EVENT_ACTION_CANCEL, 0,flags, metaState, buttonState, AMOTION_EVENT_EDGE_FLAG_NONE, mPointerGesture.lastGestureProperties, mPointerGesture.lastGestureCoords, mPointerGesture.lastGestureIdToIndex, dispatchedGestureIdBits, -1, 0, 0,mPointerGesture.downTime);
            dispatchedGestureIdBits.clear();
        } else {
            BitSet32 upGestureIdBits;
            // finishPreviousGesture었다면  dispatchMotion으로 값 전달.
            if (finishPreviousGesture) {
                upGestureIdBits = dispatchedGestureIdBits;
            } else {
                upGestureIdBits.value =
                        dispatchedGestureIdBits.value & ~mPointerGesture.currentGestureIdBits.value;
            }
            while (!upGestureIdBits.isEmpty()) {
                uint32_t id = upGestureIdBits.clearFirstMarkedBit();

dispatchMotion(when, readTime, policyFlags, mSource,AMOTION_EVENT_ACTION_POINTER_UP, 0, flags,metaState,buttonState,AMOTION_EVENT_EDGE_FLAG_NONE,mPointerGesture.lastGestureProperties,mPointerGesture.lastGestureCoords,mPointerGesture.lastGestureIdToIndex,dispatchedGestureIdBits, id, 0,0, mPointerGesture.downTime);
                dispatchedGestureIdBits.clearBit(id);
            }
        }
    }
```

### dispatchPointerGestures
추가 작성 예정.

```java
bool TouchInputMapper::preparePointerGestures(nsecs_t when, bool* outCancelPreviousGesture,bool* outFinishPreviousGesture, bool isTimeout) {
    *outCancelPreviousGesture = false;
    *outFinishPreviousGesture = false;
```